<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Obby 3D — Mini</title>

  <!-- Social preview -->
  <meta property="og:title" content="Obby 3D — Mini" />
  <meta property="og:description" content="Tap/Space to jump across floating platforms. How far can you go?" />
  <meta property="og:image" content="https://zux12.github.io/whatsapp-mini-game/preview.png" />
  <meta property="og:url" content="https://zux12.github.io/whatsapp-mini-game/" />
  <meta name="twitter:card" content="summary_large_image" />

  <link rel="icon" href="favicon.ico" />

  <style>
    :root { --bg:#0e1024; --fg:#e9ecff; --muted:#8b90b6; --accent:#69e08a; }
    html,body{height:100%; margin:0; background:radial-gradient(120vmax 120vmax at 50% -20%, #161a3a, var(--bg) 55%); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif; overflow:hidden;}

    /* Force-hide anything with [hidden] even on mobile Safari */
    [hidden]{ display:none !important; }

    #hud{
      position:fixed; inset:0; pointer-events:none; display:flex; flex-direction:column; justify-content:space-between;
      padding:12px;
    }
    .topbar{display:flex; gap:8px; align-items:center; justify-content:space-between;}
    .pill{pointer-events:auto; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); padding:8px 12px; border-radius:999px; font-variant-numeric:tabular-nums;}
    .btn{pointer-events:auto; border:0; padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:700; background:var(--accent); color:#072114; box-shadow:0 10px 24px rgba(106,224,138,.35);}
    .btn.secondary{background:#2d335e; color:#dfe3ff; box-shadow:none}

    #overlay{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:linear-gradient(180deg, rgba(10,12,30,.72), rgba(10,12,30,.55));
      backdrop-filter: blur(4px);
      z-index: 10; /* over canvas */
    }
    .card{
      width:min(92vw,540px); border-radius:20px; padding:16px; text-align:center;
      background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12);
      box-shadow:0 20px 60px rgba(0,0,0,0.45);
    }
    h1{margin:8px 0 6px; font-size:22px}
    p{margin:8px 0; color:var(--muted)}
    .row{display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-top:10px}
    #hint{font-size:13px}
  </style>
</head>
<body>
  <div id="hud">
    <div class="topbar">
      <div class="pill">Score: <b id="score">0</b></div>
      <div class="pill">Best: <b id="best">0</b></div>
      <div class="pill">Tap/Space = Jump</div>
    </div>
    <div style="display:flex; gap:8px; justify-content:center; margin-bottom:10px;">
      <button id="shareBtn" class="btn secondary">Share my score</button>
    </div>
  </div>

  <!-- Start overlay is visible by default -->
  <div id="overlay">
    <div class="card">
      <h1>Obby 3D — Mini</h1>
      <p id="summary">Jump across floating platforms. Don’t fall!</p>
      <div class="row">
        <button id="playBtn" class="btn">▶️ Play</button>
        <button id="restartBtn" class="btn" style="display:none">↻ Restart</button>
        <button id="howBtn" class="btn secondary">How to play</button>
      </div>
      <p id="hint">Tap anywhere or press Space to jump. Reach farther platforms to gain score.</p>
    </div>
  </div>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.158.0/build/three.module.js';

    // ------- Basic scene setup -------
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0d1023);
    scene.fog = new THREE.Fog(0x0d1023, 30, 120);

    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 500);
    camera.position.set(0, 4.5, 10);

    const renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // Lights
    const hemi = new THREE.HemisphereLight(0xcad8ff, 0x202535, 1.2);
    scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xffffff, 0.9);
    dir.position.set(5,8,2);
    scene.add(dir);

    // Ground ambience (far backdrop plane)
    const groundGeo = new THREE.PlaneGeometry(400, 400);
    const groundMat = new THREE.MeshPhongMaterial({ color: 0x12183a, shininess: 10, specular: 0x0 });
    const ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = -Math.PI/2;
    ground.position.y = -20;
    scene.add(ground);

    // ------- Player: Block Man (group) -------
    // Dimensions (approx): width 0.6, height 1.6, depth 0.6
    const playerGroup = new THREE.Group();

    // Palette
    const torsoCol = 0x38e1b6;   // teal
    const legCol   = 0x8b6cff;   // purple
    const armCol   = 0xffa24d;   // orange
    const headCol  = 0xfff1cc;   // warm cream
    const accentCol= 0x111422;

    const body = new THREE.Mesh(new THREE.BoxGeometry(0.6, 1.0, 0.4), new THREE.MeshStandardMaterial({ color: torsoCol, roughness: 0.45, metalness: 0.08 }));
    body.position.y = 0.8;

    const head = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.5, 0.5), new THREE.MeshStandardMaterial({ color: headCol, roughness: 0.55, metalness: 0.05 }));
    head.position.y = 1.35;

    // Eyes (two tiny dark cubes on face)
    const eyeMat = new THREE.MeshStandardMaterial({ color: 0x1c2038, roughness: 0.4, metalness: 0.1 });
    const eyeL = new THREE.Mesh(new THREE.BoxGeometry(0.07, 0.07, 0.07), eyeMat);
    const eyeR = eyeL.clone();
    eyeL.position.set(-0.12, 1.40, 0.26);
    eyeR.position.set( 0.12, 1.40, 0.26);

    // Arms (single segment each)
    const armL = new THREE.Mesh(new THREE.BoxGeometry(0.18, 0.7, 0.18), new THREE.MeshStandardMaterial({ color: armCol, roughness: 0.45, metalness: 0.08 }));
    const armR = armL.clone();
    armL.position.set(-0.44, 0.85, 0);
    armR.position.set( 0.44, 0.85, 0);

    // Legs
    const legL = new THREE.Mesh(new THREE.BoxGeometry(0.22, 0.6, 0.22), new THREE.MeshStandardMaterial({ color: legCol, roughness: 0.5, metalness: 0.05 }));
    const legR = legL.clone();
    legL.position.set(-0.18, 0.3, 0);
    legR.position.set( 0.18, 0.3, 0);

    // Cute backpack accent
    const pack = new THREE.Mesh(new THREE.BoxGeometry(0.32, 0.48, 0.16), new THREE.MeshStandardMaterial({ color: accentCol, roughness:0.6, metalness:0.05 }));
    pack.position.set(0, 0.95, -0.28);

    playerGroup.add(body, head, eyeL, eyeR, armL, armR, legL, legR, pack);
    scene.add(playerGroup);

    // Shadow plane under player (fake soft shadow)
    const shadowGeo = new THREE.CircleGeometry(0.6, 24);
    const shadowMat = new THREE.MeshBasicMaterial({ color: 0x000000, transparent:true, opacity:0.25 });
    const shadow = new THREE.Mesh(shadowGeo, shadowMat);
    shadow.rotation.x = -Math.PI/2;
    scene.add(shadow);

    // Player half extents for landing math
    const playerHalf = { x: 0.3, y: 0.8, z: 0.3 };

    // ------- Platforms -------
    const platforms = [];
    const platMatA = new THREE.MeshStandardMaterial({ color: 0x69e08a, roughness: 0.5, metalness: 0.05 });
    const platMatB = new THREE.MeshStandardMaterial({ color: 0x52b8f2, roughness: 0.5, metalness: 0.05 });
    const mats = [platMatA, platMatB];

    function makePlatform(w=2, h=0.3, d=2, x=0, y=0, z=0, mat=platMatA){
      const g = new THREE.BoxGeometry(w, h, d);
      const m = mat.clone();
      const mesh = new THREE.Mesh(g, m);
      mesh.position.set(x, y, z);
      mesh.userData = { w, h, d };
      scene.add(mesh);
      platforms.push(mesh);
      return mesh;
    }

    // Start with a MUCH LONGER & WIDER initial platform for prep time (w=4, d=8)
    let seedZ = -8; // next platforms start after this pad
    const startPlat = makePlatform(4.0, 0.3, 8.0, 0, 0.6, 0, platMatA); // big safe start

    function addChunk(n=8){
      for(let i=0;i<n;i++){
        const w = THREE.MathUtils.randFloat(1.4, 3.0);
        const d = THREE.MathUtils.randFloat(1.8, 2.5);
        const y = THREE.MathUtils.randFloat(0.6, 1.6);
        const x = THREE.MathUtils.randFloatSpread(2.2);
        seedZ -= THREE.MathUtils.randFloat(2.8, 4.8);
        const mat = mats[(Math.random()*mats.length)|0];
        makePlatform(w, 0.3, d, x, y, seedZ, mat);
      }
    }
    addChunk(14);

    // ------- Game state -------
    const state = {
      running:false,
      score:0,
      best: parseInt(localStorage.getItem('obby3d_best') || '0',10),
      zSpeed: 3.6,
      gravity: -20,
      jumpVelocity: 8.75,
      vy: 0,
      x: 0, y: 0, z: 2.0,     // temporary y; we set exact Y on resetGame()
      onPlatform: true,
      lastTime: 0,
      legPhase: 0
    };

    // HUD hooks
    const scoreEl = document.getElementById('score');
    const bestEl  = document.getElementById('best');
    bestEl.textContent = String(state.best);

    // Overlay + buttons
    const overlay = document.getElementById('overlay');
    const playBtn = document.getElementById('playBtn');
    const restartBtn = document.getElementById('restartBtn');
    const howBtn = document.getElementById('howBtn');
    const summary = document.getElementById('summary');
    const shareBtn= document.getElementById('shareBtn');

    // Robust overlay toggles (fixes Safari)
    function showOverlay(msg, withRestart=false){
      summary.textContent = msg;
      overlay.hidden = false;
      overlay.style.display = 'flex';
      overlay.style.pointerEvents = 'auto';
      playBtn.style.display = withRestart ? 'none' : 'inline-block';
      restartBtn.style.display = withRestart ? 'inline-block' : 'none'
