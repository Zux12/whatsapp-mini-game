<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Obby 3D — Mini</title>

  <!-- Social preview -->
  <meta property="og:title" content="Obby 3D — Mini" />
  <meta property="og:description" content="Tap/Space to jump across floating platforms. How far can you go?" />
  <meta property="og:image" content="https://zux12.github.io/whatsapp-mini-game/preview.png" />
  <meta property="og:url" content="https://zux12.github.io/whatsapp-mini-game/" />
  <meta name="twitter:card" content="summary_large_image" />

  <link rel="icon" href="favicon.ico" />

  <style>
    :root { --bg:#0e1024; --fg:#e9ecff; --muted:#8b90b6; --accent:#69e08a; }
    html,body{height:100%; margin:0; background:radial-gradient(120vmax 120vmax at 50% -20%, #161a3a, var(--bg) 55%); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif; overflow:hidden;}

    /* Force-hide anything with [hidden] even on mobile Safari */
    [hidden]{ display:none !important; }

    #hud{
      position:fixed; inset:0; pointer-events:none; display:flex; flex-direction:column; justify-content:space-between;
      padding:12px;
    }
    .topbar{display:flex; gap:8px; align-items:center; justify-content:space-between;}
    .pill{pointer-events:auto; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); padding:8px 12px; border-radius:999px; font-variant-numeric:tabular-nums;}
    .btn{pointer-events:auto; border:0; padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:700; background:var(--accent); color:#072114; box-shadow:0 10px 24px rgba(106,224,138,.35);}
    .btn.secondary{background:#2d335e; color:#dfe3ff; box-shadow:none}

    #overlay{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:linear-gradient(180deg, rgba(10,12,30,.72), rgba(10,12,30,.55));
      backdrop-filter: blur(4px);
      z-index: 10; /* over canvas */
    }
    .card{
      width:min(92vw,540px); border-radius:20px; padding:16px; text-align:center;
      background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12);
      box-shadow:0 20px 60px rgba(0,0,0,0.45);
    }
    h1{margin:8px 0 6px; font-size:22px}
    p{margin:8px 0; color:var(--muted)}
    .row{display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-top:10px}
    #hint{font-size:13px}
  </style>
</head>
<body>
  <div id="hud">
    <div class="topbar">
      <div class="pill">Score: <b id="score">0</b></div>
      <div class="pill">Best: <b id="best">0</b></div>
      <div class="pill">Tap/Space = Jump</div>
    </div>
    <div style="display:flex; gap:8px; justify-content:center; margin-bottom:10px;">
      <button id="shareBtn" class="btn secondary">Share my score</button>
    </div>
  </div>

  <!-- Start overlay is visible by default -->
  <div id="overlay">
    <div class="card">
      <h1>Obby 3D — Mini</h1>
      <p id="summary">Jump across floating platforms. Don’t fall!</p>
      <div class="row">
        <button id="playBtn" class="btn">▶️ Play</button>
        <button id="restartBtn" class="btn" style="display:none">↻ Restart</button>
        <button id="howBtn" class="btn secondary">How to play</button>
      </div>
      <p id="hint">Tap anywhere or press Space to jump. Reach farther platforms to gain score.</p>
    </div>
  </div>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.158.0/build/three.module.js';

    // ------- Basic scene setup -------
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0d1023);
    scene.fog = new THREE.Fog(0x0d1023, 30, 120);

    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 500);
    camera.position.set(0, 4.5, 10);

    const renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // Lights
    const hemi = new THREE.HemisphereLight(0xcad8ff, 0x202535, 1.2);
    scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xffffff, 0.9);
    dir.position.set(5,8,2);
    scene.add(dir);

    // Ground ambience (far backdrop plane)
    const groundGeo = new THREE.PlaneGeometry(400, 400);
    const groundMat = new THREE.MeshPhongMaterial({ color: 0x12183a, shininess: 10, specular: 0x0 });
    const ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = -Math.PI/2;
    ground.position.y = -20;
    scene.add(ground);

    // ------- Player: Block Man (group) -------
    // Dimensions (approx): width 0.6, height 1.6, depth 0.6
    const playerGroup = new THREE.Group();

    const bodyMat = new THREE.MeshStandardMaterial({ color: 0xE6E7FF, roughness: 0.5, metalness: 0.05 });
    const headMat = new THREE.MeshStandardMaterial({ color: 0xC7CBFF, roughness: 0.5, metalness: 0.05 });
    const legMat  = new THREE.MeshStandardMaterial({ color: 0x8ad4ff, roughness: 0.5, metalness: 0.05 });

    const body = new THREE.Mesh(new THREE.BoxGeometry(0.6, 1.0, 0.4), bodyMat);
    body.position.y = 0.8; // center of body
    const head = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.5, 0.5), headMat);
    head.position.y = 1.35;

    const legL = new THREE.Mesh(new THREE.BoxGeometry(0.22, 0.6, 0.22), legMat);
    const legR = legL.clone();
    legL.position.set(-0.18, 0.3, 0);
    legR.position.set( 0.18, 0.3, 0);

    playerGroup.add(body, head, legL, legR);
    scene.add(playerGroup);

    // Shadow plane under player (fake soft shadow)
    const shadowGeo = new THREE.CircleGeometry(0.6, 24);
    const shadowMat = new THREE.MeshBasicMaterial({ color: 0x000000, transparent:true, opacity:0.25 });
    const shadow = new THREE.Mesh(shadowGeo, shadowMat);
    shadow.rotation.x = -Math.PI/2;
    scene.add(shadow);

    // Player bounds (for landing)
    const playerHalf = { x: 0.3, y: 0.8, z: 0.3 }; // half extents

    // ------- Platforms -------
    const platforms = [];
    const platMatA = new THREE.MeshStandardMaterial({ color: 0x69e08a, roughness: 0.5, metalness: 0.05 });
    const platMatB = new THREE.MeshStandardMaterial({ color: 0x52b8f2, roughness: 0.5, metalness: 0.05 });
    const mats = [platMatA, platMatB];

    function makePlatform(w=2, h=0.3, d=2, x=0, y=0, z=0, mat=platMatA){
      const g = new THREE.BoxGeometry(w, h, d);
      const m = mat.clone();
      const mesh = new THREE.Mesh(g, m);
      mesh.position.set(x, y, z);
      mesh.userData = { w, h, d };
      scene.add(mesh);
      platforms.push(mesh);
      return mesh;
    }

    // Start with a MUCH LONGER & WIDER initial platform for prep time
    // (w=4.0, d=8.0) and shift next chunks farther forward
    let seedZ = -8; // next platforms will start after this long start pad
    makePlatform(4.0, 0.3, 8.0, 0, 0.6, 0, platMatA); // big safe start

    function addChunk(n=8){
      for(let i=0;i<n;i++){
        const w = THREE.MathUtils.randFloat(1.4, 3.0);
        const d = THREE.MathUtils.randFloat(1.8, 2.5);
        const y = THREE.MathUtils.randFloat(0.6, 1.6);
        const x = THREE.MathUtils.randFloatSpread(2.2);
        seedZ -= THREE.MathUtils.randFloat(2.8, 4.8);
        const mat = mats[(Math.random()*mats.length)|0];
        makePlatform(w, 0.3, d, x, y, seedZ, mat);
      }
    }
    addChunk(14);

    // ------- Game state -------
    const state = {
      running:false,
      score:0,
      best: parseInt(localStorage.getItem('obby3d_best') || '0',10),
      zSpeed: 3.6,
      gravity: -20,
      jumpVelocity: 8.5,
      vy: 0,
      x: 0, y: 1.2, z: 2.0,   // start a bit forward on the big platform
      onPlatform: true,
      lastTime: 0,
      legPhase: 0
    };

    // HUD hooks
    const scoreEl = document.getElementById('score');
    const bestEl  = document.getElementById('best');
    bestEl.textContent = String(state.best);

    // Overlay + buttons
    const overlay = document.getElementById('overlay');
    const playBtn = document.getElementById('playBtn');
    const restartBtn = document.getElementById('restartBtn');
    const howBtn = document.getElementById('howBtn');
    const summary = document.getElementById('summary');
    const shareBtn= document.getElementById('shareBtn');

    // Robust overlay toggles (fixes Safari)
    function showOverlay(msg, withRestart=false){
      summary.textContent = msg;
      overlay.hidden = false;
      overlay.style.display = 'flex';
      overlay.style.pointerEvents = 'auto';
      playBtn.style.display = withRestart ? 'none' : 'inline-block';
      restartBtn.style.display = withRestart ? 'inline-block' : 'none';
    }
    function hideOverlay(){
      overlay.hidden = true;
      overlay.style.display = 'none';
      overlay.style.pointerEvents = 'none';
    }

    function resetGame(){
      state.running = true;
      state.score = 0; scoreEl.textContent = '0';
      state.zSpeed = 3.6; state.gravity = -20; state.jumpVelocity = 8.5;
      state.vy = 0; state.x = 0; state.y = 1.2; state.z = 2.0;
      state.onPlatform = true; state.lastTime = performance.now();
      state.legPhase = 0;

      // Rebuild platforms (keep the long start)
      for (const p of platforms) scene.remove(p);
      platforms.length = 0;
      seedZ = -8;
      makePlatform(4.0, 0.3, 8.0, 0, 0.6, 0, platMatA);
      addChunk(14);

      hideOverlay();
    }

    function endGame(){
      state.running = false;
      if (state.score > state.best){
        state.best = state.score;
        localStorage.setItem('obby3d_best', String(state.best));
        bestEl.textContent = String(state.best);
      }
      showOverlay(`You fell! Score ${state.score}. Best ${state.best}.`, true);
    }

    function jump(){
      if(!state.running) return;
      if (state.onPlatform){
        state.vy = state.jumpVelocity;
        state.onPlatform = false;
      }
    }

    // Controls
    window.addEventListener('keydown', e=>{
      if (e.code === 'Space' || e.code === 'ArrowUp') { e.preventDefault(); jump(); }
    }, {passive:false});
    window.addEventListener('pointerdown', e=>{
      if (overlay.style.display !== 'none') return; // don't jump under overlay
      jump();
    });

    playBtn.onclick = resetGame;
    restartBtn.onclick = resetGame;
    howBtn.onclick = () => alert("Tap/Space to jump.\nStart on a longer safe platform.\nReach the next platform to score.\nGaps get trickier—don't fall!");

    // Share to WhatsApp
    shareBtn.onclick = () => {
      const url = location.href;
      const msg = `I scored ${state.best} in Obby 3D — Mini! Play: ${url}`;
      location.href = `https://wa.me/?text=${encodeURIComponent(msg)}`;
    };

    function updateCamera(dt){
      // Keep camera gently following; slight look-ahead
      const target = new THREE.Vector3(state.x, state.y + 2.2, state.z + 8.5);
      camera.position.lerp(target, Math.min(1, dt*2.5));
      camera.lookAt(state.x, state.y + 0.9, state.z - 2.0);
    }

    // AABB landing check with block-man feet
    function checkLanding(px, py, pz){
      let landed = false;
      const feetY = py - playerHalf.y;
      for (let i=0;i<platforms.length;i++){
        const p = platforms[i];
        const w = p.userData.w, h = p.userData.h, d = p.userData.d;

        const minX = p.position.x - w/2, maxX = p.position.x + w/2;
        const topY = p.position.y + h/2 + 0.001;
        const minZ = p.position.z - d/2, maxZ = p.position.z + d/2;

        const withinXZ = (px >= minX - playerHalf.x && px <= maxX + playerHalf.x &&
                          pz >= minZ - playerHalf.z && pz <= maxZ + playerHalf.z);

        // Landing if moving down and feet are just touching the top
        if (withinXZ && state.vy <= 0 && feetY <= topY && feetY >= (topY - 0.25)){
          state.y = topY + playerHalf.y;
          state.vy = 0;
          landed = true;
        }

        // Score when passing the front edge of a platform for the first time
        if (!p.userData.passed && pz < (p.position.z - d/2 - 0.2)){
          p.userData.passed = true;
          state.score += 1; scoreEl.textContent = String(state.score);
          state.zSpeed = Math.min(7.5, state.zSpeed + 0.06);
          if ((state.score % 6) === 0) addChunk(6);
        }
      }
      return landed;
    }

    function animateBlockMan(dt){
      // Simple leg swing while moving on platform; tuck in air
      state.legPhase += dt * (state.onPlatform ? (2.5 + state.zSpeed*0.3) : 6.0);
      const swing = state.onPlatform ? Math.sin(state.legPhase)*0.45 : 0.1;
      const lift  = state.onPlatform ? 0 : 0.05;

      // Legs swing opposite
      // Rotate around x for "walk" look
      // Also add a tiny body bob
      body.position.y = 0.8 + (state.onPlatform ? Math.abs(Math.sin(state.legPhase))*0.03 : 0.0);
      head.position.y = 1.35 + (state.onPlatform ? Math.abs(Math.sin(state.legPhase))*0.02 : 0.0);

      // Leg pivots: apply rotation around x
      legL.rotation.x = swing;
      legR.rotation.x = -swing;
      legL.position.y = 0.3 + lift;
      legR.position.y = 0.3 + lift;

      // Slight tilt forward when moving
      playerGroup.rotation.x = THREE.MathUtils.lerp(playerGroup.rotation.x, state.onPlatform ? 0.08 : -0.05, 0.15);
    }

    function animate(now){
      requestAnimationFrame(animate);
      const dt = Math.min(0.033, (now - (state.lastTime||now))/1000);
      state.lastTime = now;

      if (state.running){
        // Forward motion
        state.z -= state.zSpeed * dt;

        // Gravity
        state.vy += state.gravity * dt;
        state.y += state.vy * dt;

        // Landing/fall
        state.onPlatform = checkLanding(state.x, state.y, state.z);
        if (!state.onPlatform && state.y < -4) endGame();
      }

      // Update block-man transform
      playerGroup.position.set(state.x, state.y, state.z);
      animateBlockMan(dt);

      // Shadow follows and scales with height
      shadow.position.set(state.x, Math.max(0.05, state.y-0.85), state.z);
      const shadowScale = Math.max(0.35, 1.1 - (state.y-0.6)*0.25);
      shadow.scale.set(shadowScale, shadowScale, 1);

      updateCamera(dt);
      renderer.render(scene, camera);
    }
    requestAnimationFrame(animate);

    // Responsive
    window.addEventListener('resize', ()=>{
      renderer.setSize(innerWidth, innerHeight);
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
    });

    // Show overlay on load
    showOverlay("Start on a longer safe platform. Tap/Space to jump and reach the next platforms!");
  </script>
</body>
</html>
